@model List<WarmaneTracker.Web.Models.Item>

@{
    ViewData["Title"] = "Items";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="m-0">Items</h2>
    <a class="btn btn-primary" asp-action="Create">Nuevo</a>
</div>

@if (TempData["Msg"] is string msg)
{
    <div class="alert alert-info">@msg</div>
}

@{
    var median72 = ViewBag.Median72 as Dictionary<int, decimal> ?? new();

    var currentPage = (int)(ViewBag.Page ?? 1);
    var pageSize = (int)(ViewBag.PageSize ?? 50);
    var total = (int)(ViewBag.Total ?? 0);
    var q = (string?)ViewBag.Query;
    var totalPages = (int)Math.Ceiling(total / (double)pageSize);
}

<form method="get" class="mb-3 d-flex gap-2 align-items-center">
    <input class="form-control" style="max-width: 320px" type="text" name="q" value="@q" placeholder="Buscar (nombre o wowItemId)" />
    <input class="form-control" style="max-width: 120px" type="number" name="pageSize" value="@pageSize" min="10" max="200" />
    <button class="btn btn-outline-secondary" type="submit">Aplicar</button>

    <span class="ms-auto text-muted">Página @currentPage / @totalPages — Total: @total</span>
</form>

<nav class="mb-3 d-flex gap-2">
    <a class="btn btn-sm btn-outline-secondary @(currentPage <= 1 ? "disabled" : "")"
       href="@Url.Action("Index", new { page = currentPage - 1, pageSize, q })">← Anterior</a>

    <a class="btn btn-sm btn-outline-secondary @(currentPage >= totalPages ? "disabled" : "")"
       href="@Url.Action("Index", new { page = currentPage + 1, pageSize, q })">Siguiente →</a>
</nav>

<table class="table table-striped table-sm align-middle">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>URL</th>
            <th class="text-end">Median</th>
            <th class="text-end">Min</th>
            <th class="text-end">Qty</th>
            <th class="text-end">Median72h</th>
            <th>Fetched</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
        @foreach (var i in Model)
        {
            <tr>
                <td>@i.Name</td>
                <td class="text-truncate" style="max-width: 520px">
                    <a href="@i.Url" target="_blank">@i.Url</a>
                </td>
                <td class="text-end">@((i.LastMedianBuyoutGold?.ToString("0.##")) ?? "-")</td>
                <td class="text-end">@((i.LastMinBuyoutGold?.ToString("0.##")) ?? "-")</td>
                <td class="text-end">@((i.LastQty?.ToString()) ?? "-")</td>
                <td class="text-end">
                    @(median72.TryGetValue(i.Id, out var m) ? m.ToString("0.##") : "-")
                </td>
                <td>@(i.LastFetchedAtUtc?.ToString("u") ?? "-")</td>
                <td class="text-end">
                    <a class="btn btn-sm btn-outline-secondary" asp-action="Edit" asp-route-id="@i.Id">Editar</a>
                    <a class="btn btn-sm btn-outline-danger" asp-action="Delete" asp-route-id="@i.Id">Borrar</a>
                    <a class="btn btn-sm btn-outline-info" asp-action="History" asp-route-id="@i.Id">History</a>
                </td>
            </tr>
        }
    </tbody>
</table>
