@model WarmaneTracker.Web.Models.PlanStep
@using WarmaneTracker.Web.Models

@{
    ViewData["Title"] = "Alchemy Plan";
    var planName = (string)(ViewBag.PlanName ?? "Alchemy Plan");
    var step = (int)(ViewBag.Step ?? 1);
    var stepsCount = (int)(ViewBag.StepsCount ?? 1);

    var itemsByWowId = ViewBag.ItemsByWowId as Dictionary<int, Item> ?? new();
    var median72 = ViewBag.Median72ByWowId as Dictionary<int, decimal> ?? new();
    var priceGoldByWowId = ViewBag.PriceGoldByWowId as Dictionary<int, decimal> ?? new();
    var craftableWowIds = ViewBag.CraftableWowIds as HashSet<int> ?? new();
    var prevNextNotes = ViewBag.PrevNextNotes as List<PlanStepNote> ?? new();

}

<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="m-0">@planName</h2>
        <div class="text-muted">Paso @step / @stepsCount — Skill @Model.FromSkill → @Model.ToSkill</div>
    </div>

    <div class="d-flex gap-2">
        <a class="btn btn-outline-secondary @(step <= 1 ? "disabled" : "")"
           href="@Url.Action("Index", "AlchemyPlan", new { step = step - 1 })">◀ Anterior</a>

        <a class="btn btn-outline-secondary @(step >= stepsCount ? "disabled" : "")"
           href="@Url.Action("Index", "AlchemyPlan", new { step = step + 1 })">Siguiente ▶</a>
    </div>
</div>

@if (prevNextNotes.Count > 0)
{
    <div class="alert alert-warning">
        <div class="fw-bold mb-1">Antes de este paso</div>
        <ul class="mb-0">
            @foreach (var n in prevNextNotes)
            {
                <li>@n.Text</li>
            }
        </ul>
    </div>
}

<div class="card mb-3">
    <div class="card-body">
        <div class="fw-bold">@Model.RecipeName</div>
        <div class="text-muted">CraftCount recomendado: @Model.CraftCount</div>
    </div>
</div>

@if (Model.Notes?.Any(n => n.Scope == "INLINE") == true)
{
    <div class="alert alert-warning mb-3">
        <div class="fw-bold mb-2">Notas / Requisitos</div>
        <ul class="mb-0">
            @foreach (var n in Model.Notes.Where(n => n.Scope == "INLINE").OrderBy(x => x.SortOrder))
            {
                <li>
                    <span class="badge bg-secondary me-2">@n.Kind</span>
                    @if (n.MinCharacterLevel.HasValue)
                    {
                        <span class="badge bg-dark me-2">Lvl @n.MinCharacterLevel.Value+</span>
                    }
                    @n.Text
                </li>
            }
        </ul>
    </div>
}


<table class="table table-striped table-sm align-middle">
    <thead>
        <tr>
            <th>Reagent</th>
            <th class="text-end">Qty</th>
            <th class="text-end">LastMin</th>
            <th class="text-end">Median72h (avg)</th>
            <th class="text-end">Unit</th>
            <th class="text-end">Est. Cost</th>
            <th>Source</th>
            <th>Señal</th>
            <th class="text-center">OK</th>
        </tr>
    </thead>
    <tbody>
        @{
            decimal total = 0m;

            foreach (var r in Model.Reagents.OrderBy(x => x.NameHint))
            {
                itemsByWowId.TryGetValue(r.WowItemId, out var item);
                median72.TryGetValue(r.WowItemId, out var m72);

                decimal? lastMin = item?.LastMinBuyoutGold;

                // SOURCE + PRICE (gold por unidad)
                string source;
                decimal? unitPrice;

                if (r.IsVendor && priceGoldByWowId.TryGetValue(r.WowItemId, out var vGold))
                {
                    source = "VENDOR";
                    unitPrice = vGold;
                }
                else if (craftableWowIds.Contains(r.WowItemId))
                {
                    source = "CRAFT";
                    unitPrice = null; // no lo contamos como compra
                }
                else
                {
                    source = "AH";
                    unitPrice = lastMin ?? (m72 > 0 ? m72 : (decimal?)null);
                }

                var est = unitPrice.HasValue ? unitPrice.Value * r.Qty * Model.CraftCount : 0m;
                if (unitPrice.HasValue) total += est;

                // Señal solo para AH
                string signal = "-";
                if (source == "AH" && unitPrice.HasValue && m72 > 0 && lastMin.HasValue)
                {
                    if (lastMin.Value <= m72 * 0.90m) signal = "BUY";
                    else if (lastMin.Value >= m72 * 1.10m) signal = "WAIT";
                    else signal = "OK";
                }

                <tr>
                    <td>
                        <div class="fw-semibold">@(!string.IsNullOrWhiteSpace(r.NameHint) ? r.NameHint : $"Item {r.WowItemId}")</div>
                        <div class="text-muted small">WowItemId: @r.WowItemId</div>
                    </td>
                    <td class="text-end">@r.Qty</td>
                    <td class="text-end">@((lastMin?.ToString("0.##")) ?? "-")</td>
                    <td class="text-end">@((m72 > 0 ? m72.ToString("0.##") : "-"))</td>
                    <td class="text-end">@((unitPrice?.ToString("0.##")) ?? "-")</td>
                    <td class="text-end">@((unitPrice.HasValue ? est.ToString("0.##") : "-"))</td>
                    <td>@source</td>
                    <td>@signal</td>
                    <td class="text-center">
                        <input type="checkbox"
                               class="reagent-check form-check-input"
                               data-plan="@planName"
                               data-step="@step"
                               data-wowid="@r.WowItemId" />
                    </td>
                </tr>
            }
        }
    </tbody>
    <tfoot>
        <tr>
            <th colspan="6" class="text-end">Total estimado del paso</th>
            <th class="text-end">@total.ToString("0.##")</th>
            <th colspan="2"></th>
        </tr>
    </tfoot>
</table>

@section Scripts {
    <script>
        (function() {
            // Clave única por plan + step (así no se mezcla entre pasos)
            const plan = "@planName";
            const step = "@step";
            const key = `alchemy_ok:${plan}:step:${step}`;

            // Lee el estado guardado: { "2447": true, "765": true, ... }
            function loadState() {
                try { return JSON.parse(localStorage.getItem(key) || "{}"); }
                catch { return {}; }
            }

            function saveState(state) {
                localStorage.setItem(key, JSON.stringify(state));
            }

            const state = loadState();

            // 1) Pintar checks al cargar
            document.querySelectorAll(".reagent-check").forEach(cb => {
                const wowid = cb.dataset.wowid;
                cb.checked = !!state[wowid];
            });

            // 2) Guardar al cambiar
            document.addEventListener("change", (e) => {
                const cb = e.target;
                if (!cb.classList || !cb.classList.contains("reagent-check")) return;

                const wowid = cb.dataset.wowid;
                state[wowid] = cb.checked;
                saveState(state);
            });
        })();
    </script>
}
